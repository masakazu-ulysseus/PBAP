# アセンブリ番号領域検出 PoC - 検証結果レポート

## 実行概要

**日時**: 2025-11-28  
**入力画像**: `docs/AssemblyDiagram_sample/AssemblyDiagram.jpg`  
**検出手法**: アプローチ1（枠検出ベース）

## 検出結果サマリー

- **検出領域数**: 13個
- **期待値**: 4個（アセンブリ番号 31, 32, 33, 36）
- **検出率**: 目標領域は検出できている（目視確認）
- **誤検出**: 9個程度の余分な領域が検出された

## 検出アルゴリズムの動作

### ステップ1: 輪郭検出
- 検出された輪郭数: **4,033個**
- 赤枠・黒枠を色空間（HSV）で検出
- 青枠は除外

### ステップ2: フィルタリング
- フィルタ後の枠数: **26個**
- サイズ・アスペクト比でフィルタリング

### ステップ3: 領域推定
- アセンブリ番号領域として推定: **26個**

### ステップ4: 重複マージ
- マージ後の最終領域数: **13個**

## 視覚的検証

### 正常に検出された領域（例）

**Region 7** (左上の大きな領域):
- アセンブリ番号31の領域を含む
- 部品リスト（赤枠）が検出されている
- 組立図も含まれている
- ✅ **正常検出**

**Region 11, 12, 10** (上部の領域):
- アセンブリ番号32, 33, 36付近
- 部品リストが検出されている
- ✅ **正常検出の可能性**

### 誤検出された領域

残りの領域（Region 1-6, 8-9, 13）:
- ページ余白の情報
- 部品リストが含まれているが、アセンブリ番号領域ではない可能性
- ❌ **誤検出の可能性**

## 問題点と改善案

### 問題1: 誤検出が多い
**原因**:
- 赤枠・黒枠が多数存在する
- 部品リスト以外の枠（説明図、詳細図など）も検出される

**改善案**:
1. **OCRによるアセンブリ番号の検出**
   - 大きな数字（1〜200）を検出
   - 数字の周辺に枠があるかチェック
   
2. **「x1」「x2」パターンの検出**
   - 部品リストには必ず個数表示がある
   - OCRまたはパターンマッチングで確認

3. **サイズ・配置の学習**
   - 正解データ（31, 32, 33, 36）からサイズパターンを学習
   - 典型的なレイアウトをテンプレート化

### 問題2: 領域の境界が不正確
**原因**:
- 枠の位置から推定しているため、余白が多い
- アセンブリ番号の位置を考慮していない

**改善案**:
- アセンブリ番号（数字）を検出して、その位置を基準に領域を決定
- 組立図の範囲をより正確に検出

## 次のステップ

### Phase 1-B: OCRを追加したアプローチ
1. Tesseract OCRを導入
2. 大きな数字（アセンブリ番号）を検出
3. 数字の周辺に赤枠・黒枠があるか確認
4. 「x1」「x2」のパターンを検出してフィルタリング

### Phase 2: Streamlit UI統合
- 検出結果を表示
- ユーザーが枠を調整できるUI
- 誤検出を削除、検出漏れを追加できる機能

## 結論

**初回実装の評価**: ⭐⭐⭐☆☆（3/5）

✅ **良い点**:
- 目標のアセンブリ番号領域（31, 32, 33, 36）は検出できている
- 枠検出ロジックは動作している
- 検出漏れはなさそう

❌ **改善が必要な点**:
- 誤検出が多い（13個中、正解は4個程度）
- 領域の境界が不正確
- フィルタリングロジックが不十分

**推奨**: OCRを追加して精度を向上させる

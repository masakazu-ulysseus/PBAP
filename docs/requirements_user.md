---

# 📘 PBAP (PANZER BLOCKS Assist Parts) ユーザー向けシステム要件定義書

---

# 0. ドキュメント情報

* **文書名**：PBAP ユーザー向けシステム要件定義書
* **バージョン**：v1.0
* **作成日**：2025-12-02
* **対象システム**：ユーザー申請画面 (Next.js)

---

# 1. 概要

## 1.1 目的
ユーザーが **不足部品を簡易・正確に申請できるプラットフォーム** を提供する。

## 1.2 利用者
* **ユーザー**：PANZER BLOCKS 商品を購入し、不足・紛失・破損部品がある人

## 1.3 対象範囲
* 申請画面
* 送付先情報入力
* 購入者確認（購入情報 & 保証コード）
* 組立番号画像からの不足部品選択
* 申請送信 & メール通知

---

# 2. 業務フロー（ユーザー側）

## 2.1 通常フロー（製品がTBL:Productsに存在する場合）

1. PBAP（ユーザー画面）にアクセス
2. 購入情報の入力（シリーズ名選択、購入店入力、商品名選択、購入日、部品保証コード）
3. 保証コードチェック成功 → 組立番号画像一覧へ進む
4. 不足部品を、組立画像 → 組立番号画像 → 部品画像の順に選択
5. 送付先情報の入力
6. 申請内容を確認
7. 「申請する」ボタン押下
8. システムが申請データを保存し、メール送信（ユーザー・PB管理者）

## 2.2 その他フロー（製品がTBL:Productsに存在しない場合）

1. PBAP（ユーザー画面）にアクセス
2. 購入情報の入力（シリーズ名選択、購入店入力、**商品名で「その他」を選択**、購入日、部品保証コード）
3. 保証コードチェック成功 → 不足パーツ写真画面へ進む
4. 不足部品の写真をアップロード（ファイル選択 or カメラ撮影）
5. アップロードした画像に不足部品の印を付ける（フリーハンド描画）
6. 必要に応じて複数画像を追加（最大10枚）
7. 送付先情報の入力
8. 申請内容を確認
9. 「申請する」ボタン押下
10. システムが申請データを保存し、メール送信（ユーザー・PB管理者）

---

# 3. 機能要件

## 3.1 送付先情報入力

**目的**：不足部品の発送に必要な情報を取得する

**必須項目**
* 郵便番号
* 住所
* e-mail
* 電話番号
* お受け取り人氏名

**受入基準**
1. 必須項目が未入力の場合、エラー表示し次へ進めない
2. 入力形式は基本バリデーションを行う（メール形式、桁数チェックなど）

## 3.2 購入情報の登録（購入者確認）

**必須項目**
* シリーズ名（選択）
* 国（選択）
* 購入店 ／ 購入サイト名（入力）
* 商品名（選択） ※「その他」オプションを含む
* 購入日（入力）
* 部品保証コード（入力）

**受入基準**
1. 全項目が入力されていること
2. 保証コードのチェックデジットが正しい場合のみ、次画面に進む
3. 不正な保証コードの場合エラー表示
4. 商品名が「その他」以外の場合 → 部品選択画面へ
5. 商品名が「その他」の場合 → 不足パーツ写真画面へ

## 3.3 組立画像からの部品選択（通常フロー）

**対象**：商品名がTBL:Productsに存在する場合

**動作詳細**
1. 商品名に紐づく組立画像をページ送り表示
2. 組立画像には、該当ステップで使用される組立番号画像が表示されている
3. ユーザーは、組立番号画像に関連する画像を選択
4. 組立番号画像が表示される
5. ユーザーは、組立番号画像内に表示された部品画像から不足部品を選択
6. ユーザーは、不足部品の数量を入力する
7. ユーザーは複数ステップにまたがって不足部品の入力が可能

**受入基準**
1. 商品ごとに管理された最大200枚程度の組立画像をページ送りで閲覧できる
2. 組立画像1ページには、複数の組立番号画像が含まれる
3. 組立番号画像には、複数の部品画像が含まれる
4. 部品画像から不足部品を選択する
5. 不足部品は複数登録できる

## 3.4 不足パーツ写真アップロード（その他フロー）

**対象**：商品名で「その他」を選択した場合

**画面タイトル**：「2.不足パーツの写真」

**動作詳細**
1. サンプル画像（`/images/lost_parts1-768x756.webp`）を表示し、撮影方法を案内
2. ユーザーは以下のいずれかの方法で不足部品の写真をアップロード
   - 「アップロード」ボタン：ファイル選択ダイアログ
   - 「カメラ起動」ボタン：デバイスのカメラを起動して撮影
3. アップロードされた画像は自動的にリサイズ（最大1000x1000px）し、WEBP形式に変換
4. 変換後の画像をSupabase Storageに保存
5. アップロード完了後、「部品に印を付ける」ボタンが有効化
6. ユーザーはフリーハンド描画ツールで不足部品に印を付ける
7. 印を付けた画像を保存
8. 「追加」ボタンで新しい画像フレームを追加可能（最大10枚）
9. 「完了」ボタンで送付先情報画面へ遷移

**受入基準**
1. サンプル画像が正しく表示されること
2. スマートフォンからカメラ撮影が可能であること
3. アップロード画像が1000x1000px以下にリサイズされること
4. 画像がWEBP形式でSupabase Storageに保存されること
5. フリーハンド描画で画像上に印を付けられること
6. 最大10枚まで画像を追加できること
7. 11枚目以降の追加時はエラーメッセージを表示すること

**技術要件**
* 描画ライブラリ：react-konva等のCanvas描画ライブラリを使用
* 画像処理：クライアントサイドでリサイズ・WEBP変換
* ストレージ：Supabase Storage

## 3.5 申請内容確認と送信

**表示内容**
* 送付先情報
* 購入情報
* 通常フローの場合：不足部品一覧（組立番号単位）
* その他フローの場合：アップロードした写真一覧（印付き）

**受入基準**
1. ユーザーが「申請する」を押下すると申請完了
2. 完了後、ユーザー画面に完了メッセージを表示
3. DBにタスクとして保存
4. メール通知（ユーザー・管理者）を行う

---

# 4. 非機能要件

## 4.1 セキュリティ
1. HTTPS 必須
2. 認証不要（誰でもアクセス可能）

## 4.2 データバリデーション
* 全入力項目に対し基本バリデーション（未入力、形式チェック）
* 保証コードのチェックデジット検証

## 4.3 性能要件
1. 通常利用で3秒以内の画面応答を目標

## 4.4 可用性
* 稼働率：99%（MVP）

---

# 5. 通知要件

## 5.1 申請受付メール
**宛先**：ユーザー
**内容**：
* 受付完了の旨
* 入力内容
* 対応までの目安

## 5.2 完了メール
**宛先**：ユーザー
**内容**：
* 発送完了の通知
* ユーザーへのメッセージ
* 発送部品画像

---

# 6. 開発者向け情報

## 6.1 デバッグモード

パーツ選択画面において、組立番号領域の表示確認を行うためのデバッグモードが用意されています。

**有効化方法**：
URLにクエリパラメータ `debug=true` を追加

**例**：
```
http://localhost:3001/apply?debug=true
```

**動作**：
- 通常モード：組立番号領域の枠は透明、ホバー時に薄い青色で表示
- デバッグモード：組立番号領域が赤い枠で常に表示される

**用途**：
- 組立番号領域の座標が正しく設定されているかの確認
- 管理ツールで登録した領域データの検証

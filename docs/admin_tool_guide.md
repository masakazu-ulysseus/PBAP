# PBAP 管理ツール操作ガイド

## 概要

PBAP管理ツールは、Streamlitベースの管理者向けWebアプリケーションです。
商品・組立説明書の登録、部品画像の管理、ユーザーからの部品請求タスクの処理を行います。

## 起動方法

```bash
cd apps/admin-tool
source .venv/bin/activate  # 仮想環境を有効化
streamlit run src/main.py
```

デフォルトでは `http://localhost:8501` でアクセスできます。

## 画面構成

サイドバーから以下の画面に遷移できます：

| メニュー | 説明 |
|---------|------|
| 📦 商品一覧 | 登録済み商品の一覧表示・新規登録 |
| 📋 タスク管理 | ユーザーからの部品請求の管理 |

---

## 1. 商品管理

### 1.1 商品一覧画面

登録済みの商品を一覧表示します。

**表示項目:**
- No（連番）
- シリーズ名（ESシリーズ、PBシリーズ等）
- 国
- 商品名
- ページ数
- 操作ボタン

**操作:**
- `➕ 新規商品登録`: 新しい商品を登録
- `確認／編集`: 商品詳細画面へ遷移
- `🗑️`: 商品と関連データをすべて削除

### 1.2 新規商品登録

1. `➕ 新規商品登録` ボタンをクリック
2. 以下の情報を入力:
   - **製品画像**（任意）: 製品の写真
   - **シリーズ名**: ESシリーズ、PBシリーズ、その他
   - **国**: ドイツ、日本、アメリカ、ソビエト、イギリス、その他
   - **製品名**: 商品名を入力
   - **ページ数**: 組立説明書のページ数（表紙・背表紙含む）
3. `確定` ボタンで登録

**ポイント:**
- ページ数を指定すると、その数だけ「組立ページ」の枠が自動作成されます
- 後から画像をアップロードしていく運用です

---

## 2. 商品詳細画面（組立ページ管理）

商品詳細画面では、組立説明書の各ページを管理します。

### 2.1 組立ページ一覧

各ページは以下の状態で表示されます：

| 状態 | 表示 | 説明 |
|------|------|------|
| 未登録 | `📄 ページ n (画像未登録)` | 画像がまだアップロードされていない |
| 登録済み | `📄 ページ n (🔢 m個の組立番号)` | 画像登録済み、組立番号も設定済み |

### 2.2 ページ画像のアップロード

1. 未登録のページをクリック
2. `📤 画像をアップロード` でファイルを選択
3. プレビューを確認
4. `💾 保存` で登録

**対応形式:** PNG, JPG, JPEG, WebP

### 2.3 組立番号の登録

ページ画像をアップロード後、組立番号を登録します。

#### 新規登録時

1. `🔢 組立番号の枠を作成` をクリック
2. 質問に回答:
   - 「組立番号はいくつから始まりますか？」
   - 「この組立ページの組立番号はいくつありますか？」
3. 指定した数だけ組立番号の枠が作成されます

#### 追加登録時

1. `➕ 組立番号を追加` をクリック
2. 質問に回答:
   - 「組立番号はいくつから始まりますか？」
   - 「追加する組立番号はいくつありますか？」
3. 追加された枠に画像を割り当てます

### 2.4 組立番号画像の切り出し

各組立番号に対して、ページ画像から該当領域を切り出します。

**自動検出モード:**
1. `🔍 自動検出` をクリック
2. システムが色特徴（黒/赤の数字）を基に領域を検出
3. 候補が表示されたら選択して `✅ この領域を使用`

**手動切り出しモード:**
1. `✂️ 手動で切り出し` をクリック
2. 緑の枠で領域を調整
3. **ダブルクリックで確定**（重要）
4. プレビューを確認
5. `💾 保存` で登録

**ポイント:**
- `realtime_update=False` により、ダブルクリックで初めて選択が確定します
- ドラッグ中は枠が移動しますが、ダブルクリックするまで保存されません

---

## 3. 組立番号詳細画面（部品管理）

組立番号をクリックすると、その組立番号に含まれる部品を管理できます。

### 3.1 部品枠の作成

1. `🔢 この組立番号には部品がいくつありますか？` に数を入力
2. `作成` ボタンで枠を作成
3. 指定した数だけ「部品 n」の枠が作成されます

### 3.2 部品画像の割り当て

各部品枠に対して、以下の方法で画像を割り当てます：

#### 自動抽出から選択

1. `📷 自動抽出から選択` をクリック
2. 組立番号画像から自動抽出された部品候補が表示されます
3. 該当する部品画像を選択
4. `✅ この画像を使用` で割り当て

#### 手動で切り出し

1. `✂️ 手動で切り出し` をクリック
2. 緑の枠で領域を調整
3. **ダブルクリックで確定**
4. プレビューを確認
5. `💾 保存` で登録

### 3.3 部品の削除・再割り当て

- `🗑️ 画像を削除`: 割り当てられた画像を削除（枠は残る）
- `📷 自動抽出から選択` / `✂️ 手動で切り出し`: 別の画像に差し替え

---

## 4. タスク管理

### 4.1 タスク一覧画面

ユーザーからの部品請求を一覧表示します。

**フィルター機能:**
- ステータス: すべて / 未処理 / 処理中 / 完了 / キャンセル
- 検索: 商品名・受取人名で検索
- 申請日: 日付でフィルタ

**サマリー表示:**
- 未処理件数
- 処理中件数
- 完了件数
- 合計件数

### 4.2 タスク詳細画面

タスクをクリックすると詳細画面が表示されます。

**表示情報:**
- 商品情報（商品名、購入店、購入日、保証コード）
- 配送先情報（受取人、郵便番号、住所、メール、電話番号）
- リクエストされた部品一覧（画像、部品名、組立番号、数量）

### 4.3 ステータス更新

1. ステータスをドロップダウンから選択
2. `確定` ボタンで更新

**ステータス:**
- 📋 未処理（pending）
- ⏳ 処理中（processing）
- ✅ 完了（completed）
- ❌ キャンセル（cancelled）

### 4.4 発送処理

1. **管理者メモ**: 内部用のメモを記入（任意）
2. **発送部品画像**: 発送する部品の写真をアップロード
3. **メール送信**:
   - 件名と本文を確認・編集
   - 発送画像が添付されます
   - `📤 メールを送信してタスク完了` でメール送信＆ステータス完了

---

## 5. 画像処理仕様

### 5.1 画像のアップロード仕様

- **最大サイズ**: 2000px（長辺）にリサイズ
- **フォーマット**: WebP形式で保存
- **保存先**: Supabase Storage（`product-images` バケット）

### 5.2 部品自動抽出アルゴリズム

1. **最大フレーム検出**: 組立番号画像内の最大矩形を検出
2. **高精細化処理**:
   - 2倍アップスケール（INTER_CUBIC）
   - シャープ化（アンシャープマスク）
3. **ノイズ除去**: メディアンフィルタ（kernel=7）
4. **輪郭検出**:
   - 最小面積: 2000px
   - アスペクト比: 0.2〜5.0
5. **オブジェクト数フィルタ**: 1つの輪郭内に複数オブジェクトがある場合は除外

### 5.3 透明背景処理

部品画像は透明背景（RGBA）で保存されます。
白背景を自動で透明化し、WebP形式で保存します。

---

## 6. トラブルシューティング

### 手動切り出しで枠が勝手に移動する

**原因:** `realtime_update=True` の動作による自動リセット

**解決策:**
- 現在の実装は `realtime_update=False` を使用
- 枠を調整したら**ダブルクリックで確定**してください
- ダブルクリック後にプレビューが更新されます

### 自動抽出で部品が検出されない

**考えられる原因:**
- 画像のコントラストが低い
- 部品が小さすぎる（最小面積2000px未満）
- 背景と部品の色が似ている

**対処法:**
- `✂️ 手動で切り出し` を使用してください

### 画像のアップロードが失敗する

**確認事項:**
- ファイル形式: PNG, JPG, JPEG, WebP
- ファイルサイズ: 極端に大きい場合はリサイズしてください
- Supabase接続: `.env` ファイルの設定を確認

---

## 7. 環境変数

`apps/admin-tool/.env` に以下を設定:

```
SUPABASE_URL=your_supabase_url
SUPABASE_KEY=your_supabase_anon_key
RESEND_API_KEY=your_resend_api_key  # メール送信用
```

---

## 更新履歴

- 2025-12-21: 初版作成
- streamlit-cropper による手動切り出し機能を反映
